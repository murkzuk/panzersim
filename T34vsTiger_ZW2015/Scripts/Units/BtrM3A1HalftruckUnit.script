//-------------------------------------------------------------------
//
//  This code is copyright 2001 by G5 Software.
//  Any unauthorized usage, either in part or in whole of this code
//  is strictly prohibited. Violators WILL be prosecuted to the
//  maximum extent allowed by law.
//
//-------------------------------------------------------------------

// Unit Explosion
class CBtrM3A1HalftruckExplosion
  extends CHeavyTankExplosion
{
  float  Damage   = 5.0;
  float  Radius   = 1.0;
  float  AlarmRadius = 2.0f;
}

// Machine gun
class CBtrM3A1HalftruckMachineGunBulletExplosion
  extends CMachineGun762792BulletExplosion
{
  float  Damage   = CPiercing::BtrM3A1HalftruckMachineGunDamage;
}

class CBtrM3A1HalftruckMachineGunBulletControl
  extends CMachineGunBulletControl
{
  String ExplosionId = "BtrM3A1HalftruckMachineGunBulletExplosion";
  float BulletSpeed = CPiercing::BtrM3A1HalftruckMachineGunBulletSpeed; //
  float MaxDistance = CPiercing::BtrM3A1HalftruckMachineGunMaxDistance;      //
  float PenetrationPower = CPiercing::BtrM3A1HalftruckMachineGunPenetrationPower; //
  Array PenetrationByDistance = CPiercing::BtrM3A1HalftruckMachineGunPenetrationByDistance;  //
}

class CBtrM3A1HalftruckMachineGun
    extends CMachineGun
{
  float  InitBulletSpeed = CPiercing::BtrM3A1HalftruckMachineGunBulletSpeed;
  
  final static String BulletPatternId = "BtrM3A1HalftruckMachineGunBullet";

  final static Vector GravityVector   = CPiercing::AABulletGravityVector;
  final static boolean HighTrajectory  = false;

  Component BurstFireSound  = new #Emitter<C50calMachineGunFireSound>();

  final static float    LockAngleHMin     = -180.0;
  final static float    LockAngleHMax     =  180.0;
  final static float    LockAngleVMin     = -15.0;
  final static float    LockAngleVMax     =  25.0;
  final static float    BlockedLockAngle  =  1.0;

  // *** Gun parameters for behavior
  final static int  FirePeriod        = 200; // ms
  final static int  FirePeriodRandAdd = 0;   // ms

  final static boolean BurstFire      = true;
  final static int  BurstTime         = 2400; // ms
  final static int  BurstTimeRandAdd  = 0; // ms

  final static int  BurstDelay        = 2000; // ms
  final static int  BurstDelayRandAdd = 1000; // ms
  // gun specific fire mask with priorities
  final static Array GunSpecificFireMask = [
                                [["GROUND"],[]], // low priority mask: RestrictTo, Exclude
                                [[],[]], //
                                [["AIR"],[]]   //
                              ];
}

class CBtrM3A1HalftruckAnimatorA
  extends CTargetingAnimator
{
  String HorAnimName    = "turret_a";
  String VerAnimName    = "gun_a";

  float  LeftEndAngle   =  180.0;
  float  RightEndAngle  = -180.0;
  float  TopEndAngle    =  15.0;
  float  BottomEndAngle = -25.0;
}

// Movement animator

class CBtrM3A1HalftruckMovementLeftDrivingWheelAnimator
{
  String LineSpeedAnim = "";//"wheels_left";
  String TurnSpeedAnim = "wheels_turn";

  boolean RotateAnim = true;

  float MaxLineSpeed = 15.0*0.283*2.0*Math_PI;            // speed when wheel make full animation per one sec == length of circle
  float MaxTurnSpeed = Math_HALFPI / 3.0;    // max angle in rotation mode
}

class CBtrM3A1HalftruckMovementRightDrivingWheelAnimator
{
  String LineSpeedAnim = "";//"wheels_right";
  String TurnSpeedAnim = "wheels_turn";

  boolean RotateAnim = true;

  float MaxLineSpeed = 15.0*0.283*2.0*Math_PI;            // speed when wheel make full animation per one sec == length of circle
  float MaxTurnSpeed = Math_HALFPI / 3.0;    // max angle in rotation mode
}

class CBtrM3A1HalftruckBaseTrack
{
  String  JointName           = "";
  String  TrackTexName        = "Textures/u_veh_M3A1HalfTrack_track.tex";
  String  WheelAnimName       = "";

  Array   TrackTexScrollScale = [0.0, -0.4];
  float   WheelRotateScale    = 0.04;
  float   RealTrackPathScale  = 2.0f;
  boolean IsLeftTrack;

  float   WheelFWDRadius      = 0.510;         // driving wheel radius
  float   WhellFWDLiftDown    = 0.177;         // max down wheel offset
  float   WhellFWDLiftUp      = 0.106;         // max up wheel offset


  float   WheelRadius         = 0.174 + 0.057; // wheel radius + track radius
  float   WhellLiftDown       = 0.063;         // max down wheel offset
  float   WhellLiftUp         = 0.074;         // max up wheel offset

  // Collision mask [restrict], [exclude]
  Array   CollisionMask = [[CLASSIFICATOR_WALK_SURFACE], []];
}

class CBtrM3A1HalftruckLeftTrack
  extends CBtrM3A1HalftruckBaseTrack
{
  String  JointName     = "TrackLeft";
  String  WheelAnimName = "wheels_left";
  boolean IsLeftTrack = true;

  Array   WhellsAnimation =
  [
    // joint name,            animation name,            down    up
    //
    ["WheelLeftFront",   "L_Wheel_front_lift",   WhellFWDLiftDown, WhellFWDLiftUp, WheelFWDRadius],
    ["L_Wheel_Center01", "L_Wheel01_lift",       WhellLiftDown,    WhellLiftUp,    WheelRadius],
    ["L_Wheel_Center02", "L_Wheel02_lift",       WhellLiftDown,    WhellLiftUp,    WheelRadius]
  ];
}

class CBtrM3A1HalftruckRightTrack
  extends CBtrM3A1HalftruckBaseTrack
{
  String  JointName     = "TrackRight";
  String  WheelAnimName = "wheels_right";
  boolean IsLeftTrack   = false;

  Array   WhellsAnimation =
  [
    // joint name,            animation name,            down    up
    //
    ["WheelRightFront",  "R_Wheel_front_lift",   WhellFWDLiftDown, WhellFWDLiftUp, WheelFWDRadius],
    ["R_Wheel_Center01", "L_Wheel01_lift",       WhellLiftDown,    WhellLiftUp,    WheelRadius],
    ["R_Wheel_Center02", "L_Wheel02_lift",       WhellLiftDown,    WhellLiftUp,    WheelRadius]

  ];
}

class CBtrM3A1HalftruckLeftDoorAnimator
{
  String AnimationName = "L_Door";
  float  AnimationTime = 1.0;
}
class CBtrM3A1HalftruckRightDoorAnimator
{
  String AnimationName = "R_Door";
  float  AnimationTime = 1.0;
}

// ================================================
// Device classes
// ================================================

class CBtrM3A1HalftruckHullDriverDevice
  extends CHullDriverDevice
{
  String m_NormalSetId  = "Body_NormalSet";
  String m_CrashedSetId = "Body_CrashedSet";

  void HullDriverDeviceDestroyed(Component _HostObject)
  {
    Component Behavior = _HostObject.GetObject("Behavior");
    if (Behavior != null)
        Behavior.SetMoveAbility(false, 0);
//        Behavior.ActivateMovement(false);

    Component Mission = new #GameController().GetObject(SOID_MissionController);
    if (Mission != null)
    {

      Component Object = Mission.GetObject(getIdentificator(_HostObject));
      if(Object != null)
      {
        Object.SetUnitItemHPPercent("HullEngine", 0.0);
      }
    }
  }
}

class CBtrM3A1HalftruckHullGunlayerDevice
  extends CHullGunlayerDevice
{
  String m_NormalSetId  = "Turret_A_NormalSet";   //
  String m_CrashedSetId = "Turret_A_CrashedSet";    //

  void HullGunlayerDeviceDestroyed(Component _HostObject) // called when destroyed  HullDriverDevice
  {
    Component Behavior = _HostObject.GetObject("Behavior");
    if (Behavior != null)
        Behavior.SetFireAbility(false, 0);
//        Behavior.ActivateFire(false);
  }
}

class CBtrM3A1HalftruckHullEngineDevice
  extends CHullEngineDevice
{
  String m_NormalSetId  = "Body_NormalSet";
  String m_CrashedSetId = "Body_CrashedSet";

  void HullEngineDeviceDestroyed(Component _HostObject)
  {
    Component IdleSound = _HostObject.GetObject("IdleSound");
    if (IdleSound != null)
    {
      IdleSound.StopSoundPlaying(true);
    }

    Component StateControl = _HostObject.GetObject("StateControl");
    if (StateControl != null)
    {
      StateControl.SetHitPoints(0.0);
    }
    Component Mission = new #GameController().GetObject(SOID_MissionController);
    if (Mission != null)
    {
       Component Object = Mission.GetObject(getIdentificator(_HostObject));
       if(Object != null)
       {
         //Object.OnLifeStateChanged(false);
         Object.SetUnitItemHPPercent("HullDriver", 0.0);
         Object.SetUnitItemHPPercent("HullGunlayer", 0.0);
         Object.SetUnitItemHPPercent("Damaged", 0.0);
         Object.SetUnitItemHPPercent("Turret_A", 0.0);
       }
    }
  }
}

class CBtrM3A1HalftruckTrackLeftDevice
  extends CTrackLeftDevice
{
  String m_NormalSetId  = "TrackLeft_NormalSet";
  String m_CrashedSetId = "TrackLeft_CrashedSet";

  void TrackLeftDeviceDestroyed(Component _HostObject)
  {
    Component Behavior = _HostObject.GetObject("Behavior");
    if (Behavior != null)
        Behavior.SetMoveAbility(false, 0);
//        Behavior.ActivateMovement(false);
  }
}

class CBtrM3A1HalftruckTrackRightDevice
  extends CTrackRightDevice
{
  String m_NormalSetId  = "TrackRight_NormalSet";
  String m_CrashedSetId = "TrackRight_CrashedSet";

  void TrackRightDeviceDestroyed(Component _HostObject)
  {
    Component Behavior = _HostObject.GetObject("Behavior");
    if (Behavior != null)
        Behavior.SetMoveAbility(false, 0);
//        Behavior.ActivateMovement(false);
  }
}
class CBtrM3A1HalftruckTurretDevice
  extends CTurretDevice
{
  String m_NormalSetId  = "Turret_A_NormalSet";
  String m_CrashedSetId = "Turret_A_CrashedSet";

  void TurretDeviceDestroyed(Component _HostObject)
  {
    Component Behavior = _HostObject.GetObject("Behavior");
    if (Behavior != null)
        Behavior.SetFireAbility(false, 0);
//        Behavior.ActivateFire(false);

    Component Mission = new #GameController().GetObject(SOID_MissionController);
    if (Mission != null)
    {
       Component Object = Mission.GetObject(getIdentificator(_HostObject));
       if(Object != null)
       {
         Object.SetUnitItemHPPercent("HullGunlayer", 0.0);
       }
    }
  }
}
class CBtrM3A1HalftruckDamagedDevice
  extends CBulkDevice
{
  String m_NormalSetId  = "Body_NormalSet";
  String m_CrashedSetId = "Body_CrashedSet";

  void BulkDeviceDestroyed(Component _HostObject) // called when destroyed  TurretDevice
  {
    Component Behavior = _HostObject.GetObject("Behavior");
    if (Behavior != null)
        Behavior.ActivateBehavior(false);

    Component Mission = new #GameController().GetObject(SOID_MissionController);
    if (Mission != null)
    {
       Component Object = Mission.GetObject(getIdentificator(_HostObject));
       if(Object != null)
       {
         Object.SetUnitItemHPPercent("HullDriver", 0.0);
       }
    }
  }
}

class CBtrM3A1HalftruckSubstance
  extends CMetalSubstance
{
  Vector MainFrictionAxis = new Vector(1.0, 0.0, 0.0);
  float  Friction         = 0.5;
  float  Friction1        = 0.95;
  float  Elasticity       = 0.0;
}

// Behavior

class CBtrM3A1HalftruckBehaviorParams extends CBaseBehaviorParams
{
  float MaxAttackSpeed    = 7.5;
}

class CBtrM3A1HalftruckBehavior extends CBaseBTRBehavior
{
  final static Component SpecParams = new CBtrM3A1HalftruckBehaviorParams();

  boolean  CanMove            = true;
  boolean  HasRouter          = true;
  boolean  HasRadar           = true;
  boolean  ForceFrontInAttack = true;

  // *** radar parameters

  float MaxRadarDistance = 1000.0; // m
  float MinRadarDistance = 5.0;    // m
  float MaxRadarAngle    = 180.0;

  float   AttackDistanceMin = 50.0;
  float   AttackDistanceMax = 1000.0;

  // *** movement physical parameters

  // physical limitations

  Vector  MaxSpeed                      = new Vector( 12.5, 0, 0);   // m/s
  Vector  MaxNegativeSpeed              = new Vector( 6.0, 0, 0);   // m/s
  Vector  MaxAccelleration              = new Vector( 0.2, 0, 0);    // m/(s*s)
  Vector  MaxNegativeAccelleration      = new Vector( 0.1, 0, 0);  // m/(s*s)
  Vector  MaxBrakingAccelleration       = new Vector( 2.0, 0, 0);   // m/(s*s)
  Vector  MaxAngleSpeed                 = new Vector(   0, 0, 1.0);    // [rad/s]
  Vector  MaxAngleAccelleration         = new Vector(   0, 0, 0.5);  // [rad/(s*s)]
  Vector  MaxAngleBrakingAccelleration  = new Vector(   0, 0, 2.0); //1);  // [rad/(s*s)]

  float  MinRotateRadius = 13; // unit can turn when staying
}

class CBtrM3A1HalftruckManualControl
  extends CConstraintProperties
{
  // =========================================
  // Tank properties
  // =========================================

  float  Mass                 = 20000.0;
  Vector IT                   = new Vector(0.874482, 3.152529, 3.804275);
  float  Elasticity           = 0.0;  // Must be zero else tank will bouncing like ball
  float  Friction             = 0.0;

  float  SuspensionHeight = 0.3;    // cm
  float  SuspensionPower  = 10000;  // kg
  Vector GravityAccelerate    = CWorldPhysics::GravityVector;
}

class CBtrM3A1HalftruckUnit extends CUnit, CPushVehicleObject
{
  final static float DefaultHitPoints = CHitPoints::BtrM3A1HalftruckUnitHitPoints;

  static Array PostExplosionID = [
                                    ["", "BtrM3A1HalftruckExplosion"]
                                 ];

  final static Array AutomaticClassificators  = ["GROUND", "BTR", "RU"];

  final static String DefaultSurfaceControl = "PutonGround";  // LandingJoints

  static Array  LandingJoints = ["Corner_FL", "Corner_RL", "Corner_RR", "Corner_FR"];

  static Array  SubstanceArmourWidth = [
                                         [CMaterialStructure::MSID_ArmourHullFWD,     CArmourPoints::BtrM3A1HalftruckUnitArmourHullFWD    ],
                                         [CMaterialStructure::MSID_ArmourHullTOP,     CArmourPoints::BtrM3A1HalftruckUnitArmourHullTOP    ],
                                         [CMaterialStructure::MSID_ArmourHullBOTTOM,  CArmourPoints::BtrM3A1HalftruckUnitArmourHullBOTTOM ],
                                         [CMaterialStructure::MSID_ArmourHullRIGHT,   CArmourPoints::BtrM3A1HalftruckUnitArmourHullRIGHT  ],
                                         [CMaterialStructure::MSID_ArmourHullLEFT,    CArmourPoints::BtrM3A1HalftruckUnitArmourHullLEFT   ]
                                      ];

  void CBtrM3A1HalftruckUnit()
  {
    SetupMesh(new #AnimatedObject<Cu_veh_M3A1HalfTrackModel>(), [ 0, 270, 100, 30, 5]);  // #TODO [400, 270, 170, 50, 5]

    // Setup animations
    SetupAnimator(
        "MoveAnimLeft", new #MovementAnimator<CBtrM3A1HalftruckMovementLeftDrivingWheelAnimator>()
      );
    SetupAnimator(
        "MoveAnimRight", new #MovementAnimator<CBtrM3A1HalftruckMovementRightDrivingWheelAnimator>()
      );

    SetupTracks(
      new #TrackAnimator<CBtrM3A1HalftruckLeftTrack>(),
      new #TrackAnimator<CBtrM3A1HalftruckRightTrack>()
    );

    // Door animator
    //SetDoorEffects(
    //    new #LineAnimator<CBtrM3A1HalftruckLeftDoorAnimator>(),
    //    new #LineAnimator<CBtrM3A1HalftruckRightDoorAnimator>()
    //  );

    SetupWeapon("Weapon_A", new #Weapon<CBtrM3A1HalftruckMachineGun>(),
      ["Fire_A1"], new #TargetingAnimator<CBtrM3A1HalftruckAnimatorA>());

    // Creates and register unit state component
    // MoveSound, TraceEffectId

    SetMovementEffects(
        new #Emitter<CBtrM3A1HalftruckMovementSound>(),
        [
          ["Corner_RR", "GroundUnitTraceEffect"],
          ["Corner_RL", "GroundUnitTraceEffect"],
          ["Smoke",   "PetrolSmokeEffect"]
        ]
      );

    SetIdleEffects(
        new #Emitter<CBtrM3A1HalftruckIdleSound>()
      );

    SetAccelEffects(
        new #Emitter<CBtrM3A1HalftruckAccelSound>(),
        [
          ["Smoke", "PetrolAccelSmokeEffect", new Vector (0.0, 0.0, 0.0)]
        ]
      );

    SetupBehavior( new #VehicleBehavior<CBtrM3A1HalftruckBehavior>());
  }

  void Construct(
      Component _Mission,
      Component _PropMap
    )
  {
    CUnit::Construct(_Mission, _PropMap);

    GetDamageHandler().SetDamageTypeModifier(CBaseExplosion::CLASSIFICATOR_DAMAGE_BULLET762792, 0.0);
    GetDamageHandler().SetDamageTypeModifier(CBaseExplosion::CLASSIFICATOR_DAMAGE_BULLET127,    0.0);
    GetDamageHandler().SetDamageTypeModifier(CBaseExplosion::CLASSIFICATOR_DAMAGE_BUILDING, 0.0);

    // create effects for tracks: [ HostId, Effectid, ZoneId ]
    SetTrackEffects(
        _Mission,
        [
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest01, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest01, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest02 , "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest02 , "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest03   , "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest03   , "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest04, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest04, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_RoadForest, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_RoadForest, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush01, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush01, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush02, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush02, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush03, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush03, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush04, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush04, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyLarge, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyLarge, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyRegular, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyRegular, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyCasual, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyCasual, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_SpecialLongAloneTree, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_SpecialLongAloneTree, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_VillagePlanting01, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_VillagePlanting01, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_VillagePlanting02, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_VillagePlanting02, "Right" ],
          ["Vapor_L", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass01, "Left" ],
          ["Vapor_R", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass01, "Right" ],
          ["Vapor_L", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass02, "Left" ],
          ["Vapor_R", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass02, "Right" ],
          ["Vapor_L", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass03, "Left" ],
          ["Vapor_R", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass03, "Right" ],
          ["Vapor_L", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass04, "Left" ],
          ["Vapor_R", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass04, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad01, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad01, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad02, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad02, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad03, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad03, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad04, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad04, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_Road01, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_Road01, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_Road01Add, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_Road01Add, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_RoadObject, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_RoadObject, "Right" ],
          ["Vapor_L", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_AllPassable, "Left" ],
          ["Vapor_R", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_AllPassable, "Right" ],
          ["Vapor_L", "TankWaterEffect", CBaseZoneMap::ZMC_Water01, "Left" ],
          ["Vapor_R", "TankWaterEffect", CBaseZoneMap::ZMC_Water01, "Right" ],
          ["Vapor_L", "TankWaterEffect", CBaseZoneMap::ZMC_ShallowWater01, "Left" ],
          ["Vapor_R", "TankWaterEffect", CBaseZoneMap::ZMC_ShallowWater01, "Right" ],
          ["Vapor_L", "TankWaterEffect", CBaseZoneMap::ZMC_BeachWater01, "Left" ],
          ["Vapor_R", "TankWaterEffect", CBaseZoneMap::ZMC_BeachWater01, "Right" ]
        ]
      );

    CreateUnitItem(
        "HullDriver",
        CJointPoints::BtrHanomag251AusfCUnitHULL_DRIVERPoints,
        ["", ""],
        "HullDriver"
      );
    CreateUnitItem(
        "HullEngine",
        CJointPoints::BtrHanomag251AusfCUnitHULL_ENGINEPoints,
        ["", "GenericSmallFireEffect"],
        "HullEngine"
      );
    CreateUnitItem(
        "TrackLeft",
        CJointPoints::BtrHanomag251AusfCUnitTRACK_LEFTPoints,
        ["", ""],
        "TrackLeft"
      );
    CreateUnitItem(
        "TrackRight",
        CJointPoints::BtrHanomag251AusfCUnitTRACK_RIGHTPoints,
        ["", ""],
        "TrackRight"
      );
    CreateUnitItem(
        "HullGunLayer",
        CJointPoints::BtrHanomag251AusfCUnitHULL_GUNLAYERPoints,
        ["", ""],
        "HullGunlayer"
      );
    CreateUnitItem(
        "Turret_A",
        CJointPoints::BtrHanomag251AusfCUnitTURRETPoints,
        ["", ""],
        "Turret_A"
      );

    CreateUnitItem(
        "Damaged",
        CJointPoints::BtrHanomag251AusfCUnitDAMAGEDPoints,
        ["", ""],
        "Damaged"
      );

    LinkDeviceToUnitItem("HullDriver",   new CBtrHanomag251AusfCHullDriverDevice());
    LinkDeviceToUnitItem("HullGunlayer", new CBtrHanomag251AusfCHullGunlayerDevice());
    LinkDeviceToUnitItem("HullEngine",   new CBtrHanomag251AusfCHullEngineDevice());
    LinkDeviceToUnitItem("TrackLeft",    new CBtrHanomag251AusfCTrackLeftDevice());
    LinkDeviceToUnitItem("TrackRight",   new CBtrHanomag251AusfCTrackRightDevice());
    LinkDeviceToUnitItem("Turret_A",     new CBtrHanomag251AusfCTurretDevice());
    LinkDeviceToUnitItem("Damaged",      new CBtrHanomag251AusfCDamagedDevice());

    AttachEffect2("Vapor_L", "HanomagTrackEffect", new Vector(0.6, 0.0, 0.0));
    AttachEffect2("Vapor_R", "HanomagTrackEffect", new Vector(0.6, 0.0, 0.0));
    AttachEffect2("Vapor_L", "HanomagTrackEffect", new Vector(-0.6, 0.0, 0.0));
    AttachEffect2("Vapor_R", "HanomagTrackEffect", new Vector(-0.6, 0.0, 0.0));

    Component VehicleController = new #AITankVehicle<CBtrM3A1HalftruckManualControl>();
    if (null == VehicleController)
      logError("Cant setup type of vehicle control for " + getIdentificator(this));

    RegisterObject("AIVehicleController", VehicleController);
    VehicleController.SetEventHandler(this);

    Component Mesh = GetMeshComponent();
    Array BaseShapes = Mesh.GetCollisionShapes(Mesh.GetRootJoint(), false);
    Component Body = VehicleController.CreateObject(Mesh, BaseShapes);

    SetupPhysicaleObject("CBtrM3A1HalftruckSubstance", 3000.0, 0.00);

  }
  event void OnSuccessTouchTrigger(
    float _Energy
    )
  {
    //$LOG
    //logWarning("[CPushVehicleObject]: " + getIdentificator(this) + " OnSuccessTouchTrigger energy = " + new String(_Energy));
    Component PhysicsController = GetPhysicsController();
    if (null != PhysicsController)
      PhysicsController.CreateTouchTrigger(0.0);

    Component StateControl = GetStateControl();
    if (null != StateControl)
    {
      float HitPoints = StateControl.GetHitPoints() - _Energy * EnergyToHP;
      StateControl.SetHitPoints(HitPoints);

      if (HitPoints <= 0.0)
        user.SetUnitItemHPPercent("HullEngine", 0.0);
    }

    Component SurfaceControl = GetSurfaceControl();
    if (null != SurfaceControl)
      SurfaceControl.EnableSurfaceControl(false);

    // play touch sound
    if(_Energy > MinEnergyToSound)
      (new #SoundsArray()).CreateSound("TankCollisionBtrLowSpeedSound", getPosition(this));

    Component Behavior = GetBehavior();
    if (null != Behavior)
    {
      Behavior.ActivateMovement(false);
      PhysicsController.EnableControl(true);
      //$HACK
      CurrentEventID = randnum(INT_MAX);
      if (checkMask(this, [], [CLASSIFICATOR_DEAD_OBJECT]))
      {
//        logWarning("[CPushVehicleObject]: " + getIdentificator(this) + " enabling Behavior after 7 sec");
        sendEvent(7.0, getIdentificator(this), "OnBehaviorEnabled", [true, CurrentEventID]);
      }
    }

    Vector m_Point = new Vector(0.5, 0.5, 0.5);
    //PushTruck(_Energy*0.15, m_Point);
    PhysicsController.AppendExternalForce(m_Point, new Vector(0.0, 0.0, 0.0));
//    logWarning("Push: " + new String(m_Point));
  }

  event void PushTruck(
      float _Energy,
      Vector _Point
    )
  {
 //   if(checkMask(this, [], []))
 //     return;

    //SetSurfaceControl("None");
    /////////// KillHuman();

    //logWarning("[CPushVehicleObject]: " + getIdentificator(this) + " PushTruck energy = " + new String(_Energy));

    Component PhysicsController = GetPhysicsController();
    PhysicsController.EnableControl(true);
    PhysicsController.Activate(true);

//    Vector Force = (new Vector(15.0f, 15.0f, 15.0f) - (getPosition(user).origin - _Point))/3.0f;
    Vector Force = (getPosition(user).origin - _Point);
//     logWarning("Force X: " + new String(Force.x));
//     logWarning("Force Y: " + new String(Force.y));

    if (Force.x > 0)
      Force.x = 4.0 - Force.x/2;
    else
      Force.x = -4.0 + Force.x/2;

    if (Force.y > 0)
      Force.y = 4.0 - Force.y/2;
    else
      Force.y = -4.0 + Force.y/2;

    Force.z = 2.5f;

    Force.x = Force.x/3;
    Force.y =  Force.y/3;

    Component SurfaceControl = GetSurfaceControl();
    if (null != SurfaceControl)
      SurfaceControl.EnableSurfaceControl(false);

    Component Behavior = GetBehavior();
    if (null != Behavior)
    {
      Behavior.ActivateMovement(false);
      PhysicsController.EnableControl(true);
      //$HACK
      CurrentEventID = randnum(INT_MAX);
      if (checkMask(this, [], [CLASSIFICATOR_DEAD_OBJECT]))
      {
//        logWarning("[CPushVehicleObject]: " + getIdentificator(this) + " enabling Behavior after 7 sec");
        sendEvent(5.0, getIdentificator(this), "OnBehaviorEnabled", [true, CurrentEventID]);
      }
    }

//    logWarning("MODForce X: " + new String(Force.x));
//    logWarning("MODForce Y: " + new String(Force.y));

    PhysicsController.AppendExternalForce(Force, new Vector(0.3, 0.1, 0.2));
//    logWarning("Push: " + new String(Force));
  }

  void Initialize(
      Component   _Mission,
      Component   _PropMap
    )
  {
    CUnit::Initialize(_Mission, _PropMap);
 /*
     if (null != GetBehavior())
    {
      GetBehavior().SetBehRadarMask(["ENEMY", "MainMesh"], [], [], []);
    }
    else
      logError("NULL Beh");    */
  }

  // ======================================
  // Armour descriptor
  // ======================================
  Array GetArmourDescriptor()
  {
    return new Array ([
                        [CMaterialStructure::MSID_ArmourHullFWD,     CArmourPoints::BtrM3A1HalftruckUnitArmourHullFWD    ],
                        [CMaterialStructure::MSID_ArmourHullTOP,     CArmourPoints::BtrM3A1HalftruckUnitArmourHullTOP    ],
                        [CMaterialStructure::MSID_ArmourHullBOTTOM,  CArmourPoints::BtrM3A1HalftruckUnitArmourHullBOTTOM ],
                        [CMaterialStructure::MSID_ArmourHullRIGHT,   CArmourPoints::BtrM3A1HalftruckUnitArmourHullRIGHT  ],
                        [CMaterialStructure::MSID_ArmourHullLEFT,    CArmourPoints::BtrM3A1HalftruckUnitArmourHullLEFT   ]
                      ]);
  }
  event void SetModelViewState(
      boolean _State
    )
  {
    // TMP
  }
}

class CBtrM3A1Halftruck_WUnit extends CUnit, CPushVehicleObject
{
  final static float DefaultHitPoints = CHitPoints::BtrM3A1HalftruckUnitHitPoints;

  static Array PostExplosionID = [
                                    ["", "BtrM3A1HalftruckExplosion"]
                                 ];

  final static Array AutomaticClassificators  = ["GROUND", "BTR", "RU"];

  final static String DefaultSurfaceControl = "PutonGround";  // LandingJoints

  static Array  LandingJoints = ["Corner_FL", "Corner_RL", "Corner_RR", "Corner_FR"];

  static Array  SubstanceArmourWidth = [
                                         [CMaterialStructure::MSID_ArmourHullFWD,     CArmourPoints::BtrM3A1HalftruckUnitArmourHullFWD    ],
                                         [CMaterialStructure::MSID_ArmourHullTOP,     CArmourPoints::BtrM3A1HalftruckUnitArmourHullTOP    ],
                                         [CMaterialStructure::MSID_ArmourHullBOTTOM,  CArmourPoints::BtrM3A1HalftruckUnitArmourHullBOTTOM ],
                                         [CMaterialStructure::MSID_ArmourHullRIGHT,   CArmourPoints::BtrM3A1HalftruckUnitArmourHullRIGHT  ],
                                         [CMaterialStructure::MSID_ArmourHullLEFT,    CArmourPoints::BtrM3A1HalftruckUnitArmourHullLEFT   ]
                                      ];

  void CBtrM3A1Halftruck_WUnit()
  {
    SetupMesh(new #AnimatedObject<Cu_veh_M3A1HalfTrack_WModel>(), [ 0, 270, 100, 30, 5]);  // #TODO [400, 270, 170, 50, 5]

    // Setup animations
    SetupAnimator(
        "MoveAnimLeft", new #MovementAnimator<CBtrM3A1HalftruckMovementLeftDrivingWheelAnimator>()
      );
    SetupAnimator(
        "MoveAnimRight", new #MovementAnimator<CBtrM3A1HalftruckMovementRightDrivingWheelAnimator>()
      );

    SetupTracks(
      new #TrackAnimator<CBtrM3A1HalftruckLeftTrack>(),
      new #TrackAnimator<CBtrM3A1HalftruckRightTrack>()
    );

    // Door animator
    //SetDoorEffects(
    //    new #LineAnimator<CBtrM3A1HalftruckLeftDoorAnimator>(),
    //    new #LineAnimator<CBtrM3A1HalftruckRightDoorAnimator>()
    //  );

    SetupWeapon("Weapon_A", new #Weapon<CBtrM3A1HalftruckMachineGun>(),
      ["Fire_A1"], new #TargetingAnimator<CBtrM3A1HalftruckAnimatorA>());

    // Creates and register unit state component
    // MoveSound, TraceEffectId

    SetMovementEffects(
        new #Emitter<CBtrM3A1HalftruckMovementSound>(),
        [
          ["Corner_RR", "GroundUnitTraceEffect"],
          ["Corner_RL", "GroundUnitTraceEffect"],
          ["Smoke",   "PetrolSmokeEffect"]
        ]
      );

    SetIdleEffects(
        new #Emitter<CBtrM3A1HalftruckIdleSound>()
      );

    SetAccelEffects(
        new #Emitter<CBtrM3A1HalftruckAccelSound>(),
        [
          ["Smoke", "PetrolAccelSmokeEffect", new Vector (0.0, 0.0, 0.0)]
        ]
      );

    SetupBehavior( new #VehicleBehavior<CBtrM3A1HalftruckBehavior>());
  }

  void Construct(
      Component _Mission,
      Component _PropMap
    )
  {
    CUnit::Construct(_Mission, _PropMap);

    GetDamageHandler().SetDamageTypeModifier(CBaseExplosion::CLASSIFICATOR_DAMAGE_BULLET762792, 0.0);
    GetDamageHandler().SetDamageTypeModifier(CBaseExplosion::CLASSIFICATOR_DAMAGE_BULLET127,    0.0);
    GetDamageHandler().SetDamageTypeModifier(CBaseExplosion::CLASSIFICATOR_DAMAGE_BUILDING, 0.0);

    // create effects for tracks: [ HostId, Effectid, ZoneId ]
    SetTrackEffects(
        _Mission,
        [
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest01, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest01, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest02 , "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest02 , "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest03   , "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest03   , "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest04, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Forest04, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_RoadForest, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_RoadForest, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush01, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush01, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush02, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush02, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush03, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush03, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush04, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_Bush04, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyLarge, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyLarge, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyRegular, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyRegular, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyCasual, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_ShrubberyCasual, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_SpecialLongAloneTree, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_SpecialLongAloneTree, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_VillagePlanting01, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_VillagePlanting01, "Right" ],
          ["Vapor_L", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_VillagePlanting02, "Left" ],
          ["Vapor_R", "ForestUnitTraceEffect", CBaseZoneMap::ZMC_VillagePlanting02, "Right" ],
          ["Vapor_L", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass01, "Left" ],
          ["Vapor_R", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass01, "Right" ],
          ["Vapor_L", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass02, "Left" ],
          ["Vapor_R", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass02, "Right" ],
          ["Vapor_L", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass03, "Left" ],
          ["Vapor_R", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass03, "Right" ],
          ["Vapor_L", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass04, "Left" ],
          ["Vapor_R", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_Grass04, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad01, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad01, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad02, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad02, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad03, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad03, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad04, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_OffRoad04, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_Road01, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_Road01, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_Road01Add, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_Road01Add, "Right" ],
          ["Vapor_L", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_RoadObject, "Left" ],
          ["Vapor_R", "RoadUnitTraceEffect", CBaseZoneMap::ZMC_RoadObject, "Right" ],
          ["Vapor_L", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_AllPassable, "Left" ],
          ["Vapor_R", "GroundUnitTraceEffect", CBaseZoneMap::ZMC_AllPassable, "Right" ],
          ["Vapor_L", "TankWaterEffect", CBaseZoneMap::ZMC_Water01, "Left" ],
          ["Vapor_R", "TankWaterEffect", CBaseZoneMap::ZMC_Water01, "Right" ],
          ["Vapor_L", "TankWaterEffect", CBaseZoneMap::ZMC_ShallowWater01, "Left" ],
          ["Vapor_R", "TankWaterEffect", CBaseZoneMap::ZMC_ShallowWater01, "Right" ],
          ["Vapor_L", "TankWaterEffect", CBaseZoneMap::ZMC_BeachWater01, "Left" ],
          ["Vapor_R", "TankWaterEffect", CBaseZoneMap::ZMC_BeachWater01, "Right" ]
        ]
      );

    CreateUnitItem(
        "HullDriver",
        CJointPoints::BtrHanomag251AusfCUnitHULL_DRIVERPoints,
        ["", ""],
        "HullDriver"
      );
    CreateUnitItem(
        "HullEngine",
        CJointPoints::BtrHanomag251AusfCUnitHULL_ENGINEPoints,
        ["", "GenericSmallFireEffect"],
        "HullEngine"
      );
    CreateUnitItem(
        "TrackLeft",
        CJointPoints::BtrHanomag251AusfCUnitTRACK_LEFTPoints,
        ["", ""],
        "TrackLeft"
      );
    CreateUnitItem(
        "TrackRight",
        CJointPoints::BtrHanomag251AusfCUnitTRACK_RIGHTPoints,
        ["", ""],
        "TrackRight"
      );
    CreateUnitItem(
        "HullGunLayer",
        CJointPoints::BtrHanomag251AusfCUnitHULL_GUNLAYERPoints,
        ["", ""],
        "HullGunlayer"
      );
    CreateUnitItem(
        "Turret_A",
        CJointPoints::BtrHanomag251AusfCUnitTURRETPoints,
        ["", ""],
        "Turret_A"
      );

    CreateUnitItem(
        "Damaged",
        CJointPoints::BtrHanomag251AusfCUnitDAMAGEDPoints,
        ["", ""],
        "Damaged"
      );

    LinkDeviceToUnitItem("HullDriver",   new CBtrHanomag251AusfCHullDriverDevice());
    LinkDeviceToUnitItem("HullGunlayer", new CBtrHanomag251AusfCHullGunlayerDevice());
    LinkDeviceToUnitItem("HullEngine",   new CBtrHanomag251AusfCHullEngineDevice());
    LinkDeviceToUnitItem("TrackLeft",    new CBtrHanomag251AusfCTrackLeftDevice());
    LinkDeviceToUnitItem("TrackRight",   new CBtrHanomag251AusfCTrackRightDevice());
    LinkDeviceToUnitItem("Turret_A",     new CBtrHanomag251AusfCTurretDevice());
    LinkDeviceToUnitItem("Damaged",      new CBtrHanomag251AusfCDamagedDevice());

    AttachEffect2("Vapor_L", "HanomagTrackEffect", new Vector(0.6, 0.0, 0.0));
    AttachEffect2("Vapor_R", "HanomagTrackEffect", new Vector(0.6, 0.0, 0.0));
    AttachEffect2("Vapor_L", "HanomagTrackEffect", new Vector(-0.6, 0.0, 0.0));
    AttachEffect2("Vapor_R", "HanomagTrackEffect", new Vector(-0.6, 0.0, 0.0));

    Component VehicleController = new #AITankVehicle<CBtrM3A1HalftruckManualControl>();
    if (null == VehicleController)
      logError("Cant setup type of vehicle control for " + getIdentificator(this));

    RegisterObject("AIVehicleController", VehicleController);
    VehicleController.SetEventHandler(this);

    Component Mesh = GetMeshComponent();
    Array BaseShapes = Mesh.GetCollisionShapes(Mesh.GetRootJoint(), false);
    Component Body = VehicleController.CreateObject(Mesh, BaseShapes);

    SetupPhysicaleObject("CBtrM3A1HalftruckSubstance", 3000.0, 0.0);

  }
  event void OnSuccessTouchTrigger(
    float _Energy
    )
  {
    //$LOG
    //logWarning("[CPushVehicleObject]: " + getIdentificator(this) + " OnSuccessTouchTrigger energy = " + new String(_Energy));
    Component PhysicsController = GetPhysicsController();
    if (null != PhysicsController)
      PhysicsController.CreateTouchTrigger(0.0);

    Component StateControl = GetStateControl();
    if (null != StateControl)
    {
      float HitPoints = StateControl.GetHitPoints() - _Energy * EnergyToHP;
      StateControl.SetHitPoints(HitPoints);

      if (HitPoints <= 0.0)
        user.SetUnitItemHPPercent("HullEngine", 0.0);
    }

    Component SurfaceControl = GetSurfaceControl();
    if (null != SurfaceControl)
      SurfaceControl.EnableSurfaceControl(false);

    // play touch sound
    if(_Energy > MinEnergyToSound)
      (new #SoundsArray()).CreateSound("TankCollisionBtrLowSpeedSound", getPosition(this));

    Component Behavior = GetBehavior();
    if (null != Behavior)
    {
      Behavior.ActivateMovement(false);
      PhysicsController.EnableControl(true);
      //$HACK
      CurrentEventID = randnum(INT_MAX);
      if (checkMask(this, [], [CLASSIFICATOR_DEAD_OBJECT]))
      {
//        logWarning("[CPushVehicleObject]: " + getIdentificator(this) + " enabling Behavior after 7 sec");
        sendEvent(7.0, getIdentificator(this), "OnBehaviorEnabled", [true, CurrentEventID]);
      }
    }

    Vector m_Point = new Vector(0.5, 0.5, 0.5);
    //PushTruck(_Energy*0.15, m_Point);
    PhysicsController.AppendExternalForce(m_Point, new Vector(0.0, 0.0, 0.0));
//    logWarning("Push: " + new String(m_Point));
  }

  event void PushTruck(
      float _Energy,
      Vector _Point
    )
  {
 //   if(checkMask(this, [], []))
 //     return;

    //SetSurfaceControl("None");
    /////////// KillHuman();

    //logWarning("[CPushVehicleObject]: " + getIdentificator(this) + " PushTruck energy = " + new String(_Energy));

    Component PhysicsController = GetPhysicsController();
    PhysicsController.EnableControl(true);
    PhysicsController.Activate(true);

//    Vector Force = (new Vector(15.0f, 15.0f, 15.0f) - (getPosition(user).origin - _Point))/3.0f;
    Vector Force = (getPosition(user).origin - _Point);
//     logWarning("Force X: " + new String(Force.x));
//     logWarning("Force Y: " + new String(Force.y));

    if (Force.x > 0)
      Force.x = 4.0 - Force.x/2;
    else
      Force.x = -4.0 + Force.x/2;

    if (Force.y > 0)
      Force.y = 4.0 - Force.y/2;
    else
      Force.y = -4.0 + Force.y/2;

    Force.z = 2.5f;

    Force.x = Force.x/3;
    Force.y =  Force.y/3;

    Component SurfaceControl = GetSurfaceControl();
    if (null != SurfaceControl)
      SurfaceControl.EnableSurfaceControl(false);

    Component Behavior = GetBehavior();
    if (null != Behavior)
    {
      Behavior.ActivateMovement(false);
      PhysicsController.EnableControl(true);
      //$HACK
      CurrentEventID = randnum(INT_MAX);
      if (checkMask(this, [], [CLASSIFICATOR_DEAD_OBJECT]))
      {
//        logWarning("[CPushVehicleObject]: " + getIdentificator(this) + " enabling Behavior after 7 sec");
        sendEvent(5.0, getIdentificator(this), "OnBehaviorEnabled", [true, CurrentEventID]);
      }
    }

//    logWarning("MODForce X: " + new String(Force.x));
//    logWarning("MODForce Y: " + new String(Force.y));

    PhysicsController.AppendExternalForce(Force, new Vector(0.3, 0.1, 0.2));
//    logWarning("Push: " + new String(Force));
  }

  void Initialize(
      Component   _Mission,
      Component   _PropMap
    )
  {
    CUnit::Initialize(_Mission, _PropMap);
 /*
     if (null != GetBehavior())
    {
      GetBehavior().SetBehRadarMask(["ENEMY", "MainMesh"], [], [], []);
    }
    else
      logError("NULL Beh");    */
  }

  // ======================================
  // Armour descriptor
  // ======================================
  Array GetArmourDescriptor()
  {
    return new Array ([
                        [CMaterialStructure::MSID_ArmourHullFWD,     CArmourPoints::BtrM3A1HalftruckUnitArmourHullFWD    ],
                        [CMaterialStructure::MSID_ArmourHullTOP,     CArmourPoints::BtrM3A1HalftruckUnitArmourHullTOP    ],
                        [CMaterialStructure::MSID_ArmourHullBOTTOM,  CArmourPoints::BtrM3A1HalftruckUnitArmourHullBOTTOM ],
                        [CMaterialStructure::MSID_ArmourHullRIGHT,   CArmourPoints::BtrM3A1HalftruckUnitArmourHullRIGHT  ],
                        [CMaterialStructure::MSID_ArmourHullLEFT,    CArmourPoints::BtrM3A1HalftruckUnitArmourHullLEFT   ]
                      ]);
  }
  event void SetModelViewState(
      boolean _State
    )
  {
    // TMP
  }
}

